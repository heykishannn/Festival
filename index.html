<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Festival Wishes</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Reset and Base Styles */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden; /* Prevent horizontal scrolling */
            scroll-behavior: smooth; /* Smooth scrolling for anchor links */
            font-family: 'Poppins', sans-serif; /* Default font */
        }
        
        /* Animation Container - Overlays everything for animations */
        .animation-container {
            position: fixed; /* Stays in place */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allows clicks to pass through to elements behind */
            z-index: 1; /* Below content, but above backgrounds */
            overflow: hidden; /* Hides emojis that go outside the viewport */
        }
        
        /* Background Container - Holds the main and second backgrounds */
        .background-container {
            position: relative; /* For absolute positioning of backgrounds */
            width: 100%;
            min-height: 100vh; /* Ensure it covers at least the viewport height */
            overflow: hidden; /* Prevent background overflow */
        }

        /* Media Box - Displays the main image or video */
        .media-box {
            width: 90%; /* Responsive width */
            max-width: 800px; /* Consistent maximum width */
            margin: 0 auto 3rem; /* Center horizontally with bottom margin */
            border-radius: 16px; /* Rounded corners */
            overflow: hidden; /* Clip content within the border radius */
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2); /* Nice shadow for depth */
            z-index: 2; /* Ensure it's above background layers */
	    }
        
        .main-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh; /* Initially covers the viewport */
            z-index: -1; /* Position behind all content */
            background-size: cover; /* Scale background to cover the area */
            background-position: center; /* Center the background image */
            background-repeat: no-repeat; /* Prevent background repetition */
        }
        
        .second-bg {
            position: absolute;
            top: 100vh; /* Starts after the first page section */
            left: 0;
            width: 100%;
            height: 300vh; /* Generous height to accommodate scrolling */
            z-index: -1; /* Position behind all content */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: none; /* Hidden by default, shown only if a second background is set */
        }
        
        /* Content Container - Holds all the visual elements */
        .content-container {
            position: relative; /* Context for absolute positioning of frames and text */
            width: 100%;
            min-height: 100vh;
            display: flex;
            z-index: 2; /* Ensure content is above backgrounds */
            flex-direction: column; /* Stack sections vertically */
        }
        
        /* Page Section - Represents a single "page" of content */
        .page-section {
            position: relative; /* Context for absolute positioning of frames and text */
            width: 100%;
            min-height: 100vh; /* Each section fills the viewport height */
            display: flex;
            flex-direction: column;
            align-items: center; /* Center content horizontally */
            justify-content: center; /* Center content vertically */
            padding: 2rem 1rem; /* Add padding around the content */
            box-sizing: border-box; /* Padding included in element's total dimensions */
        }
        
        /* Title Frame Container - Holds the frame image and title text */
        .title-frame-container {
            position: relative; /* For absolute positioning of text */
            width: auto; /* Width determined by image or max-width */
            max-width: 800px; /* Consistent maximum width */
            margin-bottom: 2rem; /* Space below the title block */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1; /* Ensure it's above background layers */
        }
        
        .title-frame-image {
            width: 100%; /* Make image fill its container */
            display: block; /* Remove extra space below the image */
            height: auto; /* Maintain aspect ratio */
        }
        
        .title-text-container {
            position: absolute; /* Position text over the frame image */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-sizing: border-box;
            pointer-events: none; /* Allow clicks to pass through to elements below */
        }
        
        .title-text {
            font-size: 2rem; /* Default size, adjusted by JS for responsiveness */
            font-weight: bold;
            color: white; /* Default text color */
            text-shadow: 0 2px 4px rgba(0,0,0,0.5); /* Text shadow for better readability */
            width: 100%;
            max-width: 100%; /* Prevent text from touching container edges */
            line-height: 1.2; /* Good line height for titles */
        }
        
        /* Content Frame Container - Holds the wish box background image */
        .content-frame-container {
            position: relative; /* For absolute positioning of text */
            width: 100%; /* Responsive width */
            max-width: 800px; /* Consistent maximum width */
            margin-bottom: 2rem; /* Space below the content block */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1; /* Above background layers */
            aspect-ratio: 16 / 9; /* Default aspect ratio, overridden by image's aspect ratio */
        }
        
        .content-frame-image {
            width: 100%;
            height: 100%; /* Make image fill its parent container */
            object-fit: contain; /* Scale image to fit while maintaining aspect ratio */
            display: flex; /* Remove extra space below the image */
        }
        
        .wish-text-container {
            position: absolute; /* Position text over the wish box background */
            top: 0;
            left: 0;
            width: auto;
            height: auto;
            display: flex;
            flex-direction: column; /* Stack wishes vertically */
            justify-content: center; /* Center vertically */
            align-items: center; /* Center horizontally */
            text-align: center;
            box-sizing: border-box;
            pointer-events: none; /* Allow clicks to pass through */
            overflow: hidden; /* Hide content if it exceeds container boundaries */
        }
        
        .wish-text {
            font-weight: bold;
            line-height: 1.2rem; /* Line height for text */
            margin-bottom: 1rem; /* Space between wish lines */
            text-shadow: 0 2px 4px rgba(0,0,0,0.2); /* Text shadow */
            white-space: pre-line; /* Respect newlines entered in the admin panel */
            width: 100%;
            color: white; /* Default text color */
            max-width: 100%; /* Prevent text from touching container edges */
        }
        
        /* Username Field */
        .username-field {
            background: rgba(255, 255, 255, 0.1); /* Semi-transparent background */
            border: 2px solid white; /* White border */
            backdrop-filter: blur(10px); /* Blur effect */
            -webkit-backdrop-filter: blur(10px); /* Safari compatibility */
            border-radius: 40px; /* Rounded corners */
            padding: 12px 20px;
            color: white; /* Text color */
            font-size: 16px;
            outline: none; /* Remove focus outline */
            width: 90%;
            max-width: 400px; /* Max width for the input field */
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); /* Subtle shadow */
            margin-bottom: 1rem; /* Space below the input */
            font-family: inherit; /* Inherit font from body */
        }
        
        /* Action Buttons (Share/Copy) */
        .action-btn {
            padding: 0.8rem 2rem;
            border-radius: 24px; /* Pill shape */
            font-weight: 600;
            transition: all 0.3s ease; /* Smooth transitions for hover effects */
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-family: 'Poppins', sans-serif; /* Consistent font */
            font-size: 1rem;
            border: none; /* Remove default border */
            cursor: pointer; /* Indicate it's clickable */
            z-index: 1; /* Ensure buttons are above backgrounds */
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #4CAF50, #2E7D32); /* Example gradient */
            color: white;
        }
        
        /* Translate Text Link */
        .translate-text {
            color: #1F51FF; /* Blue color */
            text-decoration: underline; /* Underline for link appearance */
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 1rem;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3); /* Text shadow */
            z-index: 1;
            pointer-events: auto; /* Make it clickable */
        }
        
        /* Bottom Ad Container */
        .bottom-ad-container {
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 1rem;
            box-sizing: border-box;
            z-index: 100; /* High z-index to stay on top */
        }
        
        .bottom-ad {
            width: 100%;
            max-width: 800px; /* Match other content widths */
            height: auto;
            min-height: 90px; /* Minimum height for ad placeholder */
            z-index: 100;
            background-color: transparent;
            border-radius: 8px;
            overflow: hidden; /* Clip ad content if necessary */
        }
        
        /* Fixed Footer Ad */
        .footer-ad {
            position: fixed; /* Stays at the bottom */
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50px; /* Fixed height */
            background-color: #f0f0f0; /* Light background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100; /* High z-index to remain visible */
        }
        
        .footer-ad-content {
            width: 468px; /* Standard ad width */
            height: 60px; /* Standard ad height */
            background-color: #e0e0e0; /* Placeholder background */
        }

        /* Animation Styles - CSS keyframe animations for emojis */
        @keyframes float {
            0% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); } /* Gentle bobbing motion */
            100% { transform: translateY(0px) rotate(0deg); }
        }

        @keyframes fall {
            0% { transform: translateY(-100px); opacity: 1; } /* Start above viewport */
            100% { transform: translateY(100vh); opacity: 1; } /* Fall to the bottom */
        }

        @keyframes swirl {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(50px, 50px) rotate(180deg); } /* Rotate and move */
            100% { transform: translate(0, 0) rotate(360deg); }
        }

        @keyframes fireworks {
            0% { transform: translate(0, 0) scale(0.5); opacity: 1; } /* Start small */
            100% { transform: translate(var(--tx), var(--ty)) scale(1.5); opacity: 0; } /* Expand and fade out */
        }

        /* Applying animation classes to emoji elements */
        .floating-emoji {
            position: absolute;
            animation: float 3s ease-in-out infinite; /* Apply float animation */
            font-size: 24px; /* Default emoji size */
        }
        .falling-emoji {
            position: absolute;
            animation: fall linear forwards; /* Apply fall animation */
        }
        .swirling-emoji {
            position: absolute;
            animation: swirl 5s linear infinite; /* Apply swirl animation */
        }
        .fireworks-emoji {
            position: absolute;
            animation: fireworks 1s ease-out forwards; /* Apply fireworks animation */
        }
        
        /* Responsive Adjustments - Media Queries */
        @media (max-width: 100%px) {
            .title-text {
                font-size: 1.5rem; /* Smaller title on tablets and phones */
            }
            .wish-text {
                font-size: 1rem; /* Smaller wish text on smaller screens */
            }
            .title-text-container, .wish-text-container {
                padding: 10%; /* More padding on smaller screens to ensure text fits well */
            }
        }
    </style>
</head>
<body>
    <!-- Animation Container -->
    <div id="animationContainer" class="animation-container"></div>
    
    <!-- Background Container -->
    <div class="background-container">
        <!-- Background Layers -->
        <div id="mainBackground" class="main-bg"></div>
        <div id="secondBackground" class="second-bg"></div>
        
        <!-- Content Container -->
        <div class="content-container">
            <!-- First Page Section -->
            <section class="page-section">
                <!-- Media Box: Displays uploaded image or video -->
                <div id="mediaBox" class="media-box">
                    <!-- Media element will be inserted here by JavaScript -->
                </div>
                
                <!-- Title Frame: Displays the frame image and overlaid title -->
                <div class="title-frame-container">
                    <img id="titleFrameImage" class="title-frame-image" src="" alt="Title Frame">
                    <div class="title-text-container">
                        <h1 id="festivalTitle" class="title-text">Festival Wishes</h1>
                    </div>
                </div>
                
                <!-- Content Frame: Displays the wish box background and overlaid text -->
                <div class="content-frame-container">
                    <img id="contentFrameImage" class="content-frame-image" src="" alt="Content Frame">
                    <div class="wish-text-container">
                        <p id="hindiWish" class="wish-text">‡§∂‡•Å‡§≠‡§ï‡§æ‡§Æ‡§®‡§æ‡§è‡§Ç</p>
                        <p id="englishWish" class="wish-text hidden">Best Wishes</p>
                        <div id="translateBtn" class="translate-text hidden">Translate to English</div>
                    </div>
                </div>
                
                <!-- Username Input Field -->
                <input type="text" id="userName" placeholder="Enter your name" class="username-field">
                
                <!-- Action Buttons (Share/Copy) - Hidden until username is entered -->
                <div id="actionButtons" class="hidden flex flex-col items-center gap-4 mt-6" style="z-index: 1;">
                    <button id="shareBtn" class="action-btn btn-gradient hover:shadow-lg hover:scale-105 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12a2.5 2.5 0 0 1 1.088 2.076z"/>
                        </svg>
                        Share
                    </button>
                    <button id="copyBtn" class="action-btn btn-gradient hover:shadow-lg hover:scale-105 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                            <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                        </svg>
                        Copy
                    </button>
                </div>
                
                <!-- Bottom Ad Placeholder -->
                <div class="bottom-ad-container">
                    <div id="bottomAd" class="bottom-ad">
                        <!-- Ad Script Placeholder -->
                        <script type="text/javascript">
                            atOptions = {
                                'key' : '8a596a14d2ea184cd9b6372e267b931c',
                                'format' : 'iframe',
                                'height' : 50,
                                'width' : 320,
                                'params' : {}
                            };
                        </script>
                        <script type="text/javascript" src="//www.highperformanceformat.com/8a596a14d2ea184cd9b6372e267b931c/invoke.js"></script>
                    </div>
                </div>
            </section>
            
            <!-- Second Page Section - Initially hidden -->
            <section id="secondPage" class="page-section">
                <!-- Additional content can be added here if the admin sets it up -->
            </section>
        </div>
    </div>
    
    <!-- Fixed Footer Ad -->
    <div class="footer-ad">
        <div id="footerAd" class="footer-ad-content">
            <!-- Ad Script Placeholder -->
            <script type="text/javascript">
                atOptions = {
                    'key' : 'f3980c7d80f3803dbaf4228f02da605b',
                    'format' : 'iframe',
                    'height' : 60,
                    'width' : 468,
                    'params' : {}
                };
            </script>
            <script type="text/javascript" src="//www.highperformanceformat.com/f3980c7d80f3803dbaf4228f02da605b/invoke.js"></script>
        </div>
    </div>
    
    <!-- Audio Element - For background music -->
    <audio id="backgroundAudio" loop></audio>
    
    <script>
        // Initialize Supabase Client
        const supabaseUrl = 'https://udupfqyxsxfmcekumrph.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkdXBmcXl4c3hmbWNla3VtcnBoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1NTgxOTYsImV4cCI6MjA2NjEzNDE5Nn0.-ndlXo0XeRrzONovcOeiMZxeYY4st7XUXyVdWZVbZJs';
        const supaClient = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // DOM Element References - Get references to all necessary elements
        const mainBackground = document.getElementById('mainBackground');
        const secondBackground = document.getElementById('secondBackground');
        const mediaBox = document.getElementById('mediaBox');
        const titleFrameImage = document.getElementById('titleFrameImage');
        const festivalTitle = document.getElementById('festivalTitle');
        const contentFrameImage = document.getElementById('contentFrameImage');
        const hindiWishElement = document.getElementById('hindiWish');
        const englishWishElement = document.getElementById('englishWish');
        const userNameInput = document.getElementById('userName');
        const actionButtonsContainer = document.getElementById('actionButtons');
        const shareBtn = document.getElementById('shareBtn');
        const copyBtn = document.getElementById('copyBtn');
        const translateBtn = document.getElementById('translateBtn');
        const backgroundAudio = document.getElementById('backgroundAudio');
        const bottomAd = document.getElementById('bottomAd');
        const footerAd = document.getElementById('footerAd');
        const secondPageSection = document.getElementById('secondPage');
        const animationContainer = document.getElementById('animationContainer');
        
        // Constants
        const FIXED_SHARE_URL = 'https://heykishannn.github.io/Festival/'; // The base URL for sharing
        
        // State variables
        let isTranslated = false; // Track if the English wish is currently displayed
        let originalHindiWish = '‡§∂‡•Å‡§≠‡§ï‡§æ‡§Æ‡§®‡§æ‡§è‡§Ç'; // Default Hindi wish
        let originalEnglishWish = 'Best Wishes'; // Default English wish
        let shareDescription = 'sent you festival wishes!'; // Default text for sharing
        let hasSecondPageContent = false; // Flag if the second page is used
        let audioPlayAttempted = false; // Flag to prevent multiple audio play attempts
        
        // Default settings for fallback if Supabase fails or no settings are found
        const defaultSettings = {
            background: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)',
            title: 'Festival Wishes',
            hindiWish: '‡§∂‡•Å‡§≠‡§ï‡§æ‡§Æ‡§®‡§æ‡§è‡§Ç',
            englishWish: 'Best Wishes',
            shareDescription: 'sent you festival wishes!',
            frameUrl: '',
            wishBgUrl: '',
            mediaUrl: '',
            audioUrl: '',
            animationEnable: false,
            animationType: 'float',
            emojiType: 'mixed',
            customEmojis: '',
            animationQuantity: 'medium',
            customQuantity: '',
            animationSpeed: '1',
            titleFont: "'Poppins', sans-serif", titleColor: '#4c1d95', titleSize: 'text-3xl',
            hindiFont: "'Noto Sans Devanagari', sans-serif", hindiColor: '#4c1d95', hindiSize: '1.5rem',
            englishFont: "'Poppins', sans-serif", englishColor: '#4c1d95', englishSize: '1.5rem',
            buttonStyle: 'gradient', buttonColor: '#4CAF50'
        };
        
        // Event Listener: Resume audio playback when the tab becomes visible
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                playBackgroundAudio(); // Attempt to play audio
            } else {
                backgroundAudio.pause(); // Pause audio when tab is hidden
            }
        });

        // Function to play background audio, respecting browser autoplay policies
        function playBackgroundAudio() {
            if (backgroundAudio.src && !audioPlayAttempted) { // Only if audio source exists and play hasn't been attempted
                const playPromise = backgroundAudio.play(); // Attempt to play
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        audioPlayAttempted = true; // Mark as attempted
                        console.log('Background audio playing.');
                    })
                    .catch(error => {
                        console.log('Autoplay prevented:', error);
                        // If autoplay is blocked, prompt user interaction (e.g., click) to play audio
                        const onceOptions = { once: true }; // Listen only once
                        document.body.addEventListener('click', () => {
                            backgroundAudio.play().then(() => {
                                audioPlayAttempted = true;
                                console.log('Background audio playing after user interaction.');
                            }).catch(e => console.log('Autoplay still prevented:', e)); // Handle cases where even interaction fails
                        }, onceOptions);
                    });
                }
            }
        }
        
        // Function to adjust frame heights and text padding dynamically
        function adjustFrameHeightsAndTextPadding() {
            // Adjust Title Frame height and title font size
            if (titleFrameImage.src && titleFrameImage.complete) { // Ensure image is loaded
                if (titleFrameImage.naturalHeight > 0 && titleFrameImage.naturalWidth > 0) {
                    const aspectRatio = titleFrameImage.naturalHeight / titleFrameImage.naturalWidth;
                    const containerWidth = titleFrameImage.parentElement.offsetWidth;
                    titleFrameImage.parentElement.style.height = `${containerWidth * aspectRatio}px`; // Set height based on aspect ratio
                    
                    // Responsive font size for title based on screen width and container size
                    const maxWidthPixels = 800; // Reference max width
                    const responsiveScale = Math.min(1, containerWidth / maxWidthPixels); // Scale factor
                    let baseFontSizePx = 36; // Base font size for large screens
                    if (window.innerWidth < 768) baseFontSizePx = 28; // Smaller base for tablets/phones
                    if (window.innerWidth < 480) baseFontSizePx = 24; // Even smaller for small phones
                    
                    festivalTitle.style.fontSize = `${baseFontSizePx * responsiveScale}px`; // Apply calculated font size
                    
                } else { // Handle broken image links or zero dimensions
                    titleFrameImage.parentElement.style.display = 'none'; 
                }
            } else { // Hide if image is not loaded or no src is set
                titleFrameImage.parentElement.style.display = titleFrameImage.src ? 'flex' : 'none';
            }
            
            // Adjust Content Frame height and wish text container padding
            if (contentFrameImage.src && contentFrameImage.complete) { // Ensure image is loaded
                if (contentFrameImage.naturalHeight > 0 && contentFrameImage.naturalWidth > 0) {
                    const aspectRatio = contentFrameImage.naturalHeight / contentFrameImage.naturalWidth;
                    const containerWidth = contentFrameImage.parentElement.offsetWidth;
                    contentFrameImage.parentElement.style.height = `${containerWidth * aspectRatio}px`; // Set height based on aspect ratio
                    
                    // Dynamically adjust padding of wish text container based on text length
                    const textElement = isTranslated ? englishWishElement : hindiWishElement; // Get currently displayed text
                    const textContent = textElement.innerHTML.replace(/<br>/g, ''); // Remove <br> for accurate length calculation
                    const textLength = textContent.length;
                    
                    // Calculate padding to ensure text fits well and background is visible
                    const basePaddingPercent = 25; // Max padding percentage
                    const minPaddingPercent = 8;  // Min padding percentage
                    const sensitivityFactor = 0.5; // Adjust for how quickly padding decreases
                    
                    const paddingPercent = Math.max(minPaddingPercent, basePaddingPercent - (textLength - 50) * sensitivityFactor); // Formula for padding
                    
                    document.querySelector('.wish-text-container').style.padding = `${paddingPercent}%`; // Apply calculated padding

                } else { // Handle broken image links or zero dimensions
                    contentFrameImage.parentElement.style.display = 'none';
                }
            } else { // Hide if image is not loaded or no src is set
                contentFrameImage.parentElement.style.display = contentFrameImage.src ? 'flex' : 'none';
            }
        }

        // Function to process wish text: converts newlines into <br> tags
        function processWishText(text) {
            if (!text) return ''; // Return empty string if text is null or undefined
            return text.replace(/\n/g, '<br>'); // Replace newline characters with <br> tags
        }

        // Function to load settings from Supabase
        async function loadSettings() {
            try {
                const { data, error } = await supaClient
                    .from('settings')
                    .select('value')
                    .eq('id', 'festival_settings')
                    .single(); // Fetch the single settings record

                // Merge fetched settings with defaults to ensure all properties are present
                const settings = (data && data.value) ? { ...defaultSettings, ...data.value } : defaultSettings;

                // Apply Backgrounds
                if (settings.background) {
                    if (settings.background.startsWith('http') || settings.background.startsWith('data:')) {
                        mainBackground.style.backgroundImage = `url('${settings.background}')`; // Use URL for images
                    } else {
                        mainBackground.style.background = settings.background; // Use direct value for gradients/colors
                    }
                }

                if (settings.secondBackground) {
                    if (settings.secondBackground.startsWith('http') || settings.secondBackground.startsWith('data:')) {
                        secondBackground.style.backgroundImage = `url('${settings.secondBackground}')`;
                        secondBackground.style.display = 'block'; // Show the second background element
                    } else {
                        secondBackground.style.background = settings.secondBackground;
                        secondBackground.style.display = 'block';
                    }    
                }

                // Set Title and Meta Title
                document.title = settings.title || defaultSettings.title;
                festivalTitle.textContent = settings.title || defaultSettings.title;

                // Apply Title Styles (Font, Color, Size)
                festivalTitle.style.fontFamily = settings.titleFont || defaultSettings.titleFont;
                festivalTitle.style.color = settings.titleColor || defaultSettings.titleColor;
                festivalTitle.style.fontSize = settings.titleSize || defaultSettings.titleSize; // Apply direct CSS value

                // Set Wishes and their styles
                originalHindiWish = settings.hindiWish || defaultSettings.hindiWish;
                originalEnglishWish = settings.englishWish || defaultSettings.englishWish;
                
                hindiWishElement.innerHTML = processWishText(originalHindiWish); // Set Hindi wish with <br> tags
                hindiWishElement.style.fontFamily = settings.hindiFont || defaultSettings.hindiFont;
                hindiWishElement.style.color = settings.hindiColor || defaultSettings.hindiColor;
                hindiWishElement.style.fontSize = settings.hindiSize || defaultSettings.hindiSize;

                // Handle English wish and translation button visibility
                if (originalEnglishWish && originalEnglishWish.trim() !== '') {
                    englishWishElement.innerHTML = processWishText(originalEnglishWish);
                    englishWishElement.style.fontFamily = settings.englishFont || defaultSettings.englishFont;
                    englishWishElement.style.color = settings.englishColor || defaultSettings.englishColor;
                    englishWishElement.style.fontSize = settings.englishSize || defaultSettings.englishSize;
                    
                    translateBtn.classList.remove('hidden'); // Show translate button
                } else {
                    englishWishElement.classList.add('hidden'); // Hide if no English wish
                    translateBtn.classList.add('hidden');
                }

                // Set Share Description text
                shareDescription = settings.shareDescription || defaultSettings.shareDescription;

                // Set Media (Image or Video)
                if (settings.mediaUrl && settings.mediaUrl.trim() !== '') {
                    mediaBox.innerHTML = ''; // Clear any previous media
                    let mediaElement = null;
                    // Determine if it's a video or image based on URL extension
                    if (settings.mediaUrl.toLowerCase().endsWith('.mp4') || settings.mediaUrl.toLowerCase().endsWith('.webm')) {
                        mediaElement = document.createElement('video');
                        mediaElement.autoplay = true; // Autoplay video
                        mediaElement.loop = true;      // Loop video
                        mediaElement.muted = true;     // Mute video for autoplay compliance
                        mediaElement.controls = false; // No controls needed for background video
                    } else {
                        mediaElement = document.createElement('img'); // It's an image
                    }
                    mediaElement.src = settings.mediaUrl;
                    mediaElement.style.width = '100%';
                    mediaElement.style.height = 'auto';
                    mediaElement.style.display = 'block';
                    mediaBox.appendChild(mediaElement);
                }

                // Set Title Frame Image
                if (settings.frameUrl && settings.frameUrl.trim() !== '') {
                    titleFrameImage.src = settings.frameUrl;
                    // Use onload to ensure dimensions are ready before adjusting layout
                    titleFrameImage.onload = adjustFrameHeightsAndTextPadding; 
                    titleFrameImage.onerror = function() { // Handle cases where image loading fails
                        console.error('Failed to load title frame image:', this.src);
                        this.parentElement.style.display = 'none'; // Hide frame container if image is broken
                    };
                } else {
                    titleFrameImage.style.display = 'none'; // Hide frame if no URL is provided
                }

                // Set Content Frame Image (Wish Box Background)
                if (settings.wishBgUrl && settings.wishBgUrl.trim() !== '') {
                    contentFrameImage.src = settings.wishBgUrl;
                    contentFrameImage.onload = adjustFrameHeightsAndTextPadding; // Adjust layout on image load
                    contentFrameImage.onerror = function() { // Handle broken image links
                        console.error('Failed to load content frame image:', this.src);
                        this.parentElement.style.display = 'none'; // Hide frame container if image fails
                    };
                    // Apply background size and repeat properties to the parent container
                    contentFrameImage.parentElement.style.objectFit = settings.wishBgSize || 'cover';
                    contentFrameImage.parentElement.style.backgroundRepeat = settings.wishBgRepeat || 'no-repeat';
                } else {
                    contentFrameImage.style.display = 'none'; // Hide frame if no URL is provided
                }

                // Set Background Audio source
                if (settings.audioUrl && settings.audioUrl.trim() !== '') {
                    backgroundAudio.src = settings.audioUrl;
                    // Play audio immediately if autoplay is enabled in settings
                    if (settings.autoplay) {
                        playBackgroundAudio();
                    }
                }

                // Apply Button Styles based on admin's selection
                applyButtonStyles(settings.buttonStyle, settings.buttonColor);

                // Check if the second page content is enabled (admin sets a flag)
                if (settings.secondPageContent) { 
                    secondPageSection.style.display = 'flex'; // Show the second page section
                    hasSecondPageContent = true;
                }

                // Initialize animations if they are enabled
                if (settings.animationEnable) {
                    initAnimations(settings);
                }

                // Adjust scroll height and overflow based on whether there's a second page
                adjustScrollHeight();

                // Perform a final adjustment after all elements might have loaded, to ensure correct layout
                setTimeout(adjustFrameHeightsAndTextPadding, 100); // Small delay to allow images to load

            } catch (error) {
                console.error('Error loading settings from Supabase:', error);
                applyDefaultSettings(); // Apply default settings if Supabase loading fails
            }
        }
        
        // Apply default settings if Supabase fails or no settings are found
        function applyDefaultSettings() {
            document.title = defaultSettings.title;
            festivalTitle.textContent = defaultSettings.title;
            
            hindiWishElement.innerHTML = processWishText(defaultSettings.hindiWish);
            englishWishElement.innerHTML = processWishText(defaultSettings.englishWish);
            
            shareDescription = defaultSettings.shareDescription;
            
            // Hide frame images by default if no default URL is set (they are optional)
            titleFrameImage.style.display = 'none';
            contentFrameImage.style.display = 'none';
            
            // Show translate button only if an English wish is defined in defaults
            if (defaultSettings.englishWish && defaultSettings.englishWish.trim() !== '') {
                translateBtn.classList.remove('hidden');
            } else {
                translateBtn.classList.add('hidden');
            }

            applyButtonStyles(defaultSettings.buttonStyle, defaultSettings.buttonColor); // Apply default button styles
            adjustScrollHeight(); // Adjust scroll based on default page structure
        }

        // Initialize animations based on loaded settings
        function initAnimations(settings) {
            animationContainer.innerHTML = ''; // Clear any existing animations before starting new ones
            
            const emojiSet = getEmojiSet(settings.emojiType, settings.customEmojis); // Get the emoji set
            const quantity = getAnimationQuantity(settings.animationQuantity, settings.customQuantity); // Get the number of emojis
            const speed = getAnimationSpeed(settings.animationSpeed, settings.customSpeed); // Get the animation speed multiplier
            const animationType = settings.animationType || 'float'; // Default to 'float' if not specified
            
            // Create the specified number of emoji elements
            for (let i = 0; i < quantity; i++) {
                createEmoji(emojiSet, speed, animationType);
            }
        }
        
        // Function to create and append a single animated emoji element
        function createEmoji(emojiSet, speed, animationType) {
            const emoji = document.createElement('div');
            emoji.textContent = emojiSet[Math.floor(Math.random() * emojiSet.length)]; // Pick random emoji from the set
            emoji.style.fontSize = `${Math.random() * 20 + 16}px`; // Randomize emoji size
        
            switch(animationType) {
                case 'fall':
                    emoji.className = 'falling-emoji';
                    emoji.style.top = '-50px'; // Start above the viewport
                    emoji.style.left = `${Math.random() * 100}%`; // Random horizontal position
                    emoji.style.fontSize = `${1 + Math.random() * 2}rem`; // Larger random sizes for falling effect
                    emoji.style.animationDuration = `${(2 + Math.random() * 3) / speed}s`; // Random duration, scaled by speed
                    break;              
                case 'swirl':
                    emoji.className = 'swirling-emoji';
                    emoji.style.animationDuration = `${8 / speed}s`; // Adjust duration by speed
                    emoji.style.left = `${Math.random() * 100}%`;
                    emoji.style.top = `${Math.random() * 100}%`;
                    break;
                case 'fireworks':
                    emoji.className = 'fireworks-emoji';
                    emoji.style.setProperty('--tx', `${Math.random() * 200 - 100}px`); // Random horizontal offset
                    emoji.style.setProperty('--ty', `${Math.random() * 200 - 100}px`); // Random vertical offset
                    emoji.style.left = '50%'; // Center point for explosion
                    emoji.style.top = '50%';
                    emoji.style.animationDuration = `${1 / speed}s`; // Fast animation, scaled by speed
                    break;
                case 'confetti':
                    emoji.className = 'fireworks-emoji'; // Re-use fireworks animation styling
                    emoji.style.setProperty('--tx', `${Math.random() * 200 - 100}px`);
                    emoji.style.setProperty('--ty', `${Math.random() * 200 - 100}px`);
                    emoji.style.left = '50%';
                    emoji.style.top = '50%';
                    emoji.style.animationDuration = `${1.5 / speed}s`; // Slightly longer duration for confetti
                    break;
                default: // 'float' animation (default)
                    emoji.className = 'floating-emoji';
                    emoji.style.animationDuration = `${3 / speed}s`; // Adjust duration by speed
                    emoji.style.left = `${Math.random() * 100}%`;
                    emoji.style.top = `${Math.random() * 100}%`;
            }
        
            animationContainer.appendChild(emoji); // Add the created emoji to the animation container
            
            // For animations that should disappear after playing once (fall, fireworks, confetti)
            if (animationType === 'fall' || animationType === 'fireworks' || animationType === 'confetti') {
                emoji.addEventListener('animationend', () => {
                    emoji.remove(); // Remove the emoji element after animation ends
                    createEmoji(emojiSet, speed, animationType); // Create a replacement emoji
                });
            }
        }
        
        // Helper function to get an emoji set based on type or custom input
        function getEmojiSet(type, customEmojis) {
            const sets = { // Predefined emoji sets
                flowers: ['üå∏', 'üå∫', 'üåª', 'üåº', 'üå∑', 'üíê'],
                diyas: ['ü™î', '‚ú®', 'üïØÔ∏è', 'üåü'],
                rangoli: ['üü°', 'üî¥', 'üü¢', 'üîµ', 'üü£'],
                festive: ['üéâ', 'üéä', 'ü™Ö', 'üéÅ', 'üßß'],
                hearts: ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú'],
                stars: ['‚≠ê', 'üåü', '‚ú®', 'üí´'],
                mixed: ['üéâ', '‚ú®', '‚ù§Ô∏è', 'üå∏', 'üåü', 'üé∂', 'üíñ', 'üí´'] // A general mix
            };
            
            if (type === 'custom' && customEmojis) {
                const emojis = customEmojis.split(',').map(e => e.trim()).filter(e => e.length > 0); // Split and clean custom emojis
                if (emojis.length > 0) return emojis; // Return custom emojis if valid
            }
            return sets[type] || sets.mixed; // Fallback to 'mixed' if type is invalid or custom emojis are empty
        }
        
        // Helper function to get the desired animation quantity (number of emojis)
        function getAnimationQuantity(type, customQuantity) {
            const quantities = { // Mapping of quantity levels to numbers
                low: 5,
                medium: 10,
                high: 20,
                'very-high': 30
            };
            
            if (type === 'custom' && customQuantity) {
                const qty = parseInt(customQuantity);
                // Ensure quantity is a positive number, capped at 100
                if (!isNaN(qty) && qty > 0) return Math.min(100, qty); 
            }
            return quantities[type] || 10; // Default to medium quantity
        }
        
        // Helper function to get the animation speed multiplier
        function getAnimationSpeed(type, customSpeed) {
            if (type === 'custom' && customSpeed) {
                const speed = parseFloat(customSpeed);
                // Ensure speed is a valid positive number
                if (!isNaN(speed) && speed > 0) return speed; 
            }
            return parseFloat(type) || 1; // Default to 1x speed
        }
        
        // Apply button styles based on selected style and color
        function applyButtonStyles(style, color) {
            const buttons = [shareBtn, copyBtn]; // Apply styles to both action buttons
            
            // Use default values if style or color are not provided
            if (!style) style = 'gradient';
            if (!color) color = '#4CAF50';

            if (style === 'gradient') {
                const color1 = color;
                const color2 = adjustColor(color, -20); // Create a slightly darker shade for the gradient
                
                buttons.forEach(btn => {
                    btn.style.background = `linear-gradient(135deg, ${color1}, ${color2})`;
                    btn.style.border = 'none'; // Remove border for gradient style
                    btn.style.color = 'white'; // Ensure text color is white
                });
            } else if (style === 'solid') {
                buttons.forEach(btn => {
                    btn.style.background = color;
                    btn.style.border = 'none'; // Remove border for solid style
                    btn.style.color = 'white';
                });
            } else if (style === 'outline') {
                buttons.forEach(btn => {
                    btn.style.background = 'transparent'; // Transparent background
                    btn.style.border = `2px solid ${color}`; // Border color matches the selected color
                    btn.style.color = color; // Text color matches the border color
                });
            }
        }
        
        // Helper function to adjust color brightness/darkness for gradients
        function adjustColor(color, amount) {
            let usePound = false;
            if (color[0] === "#") { // Check if hex code starts with #
                color = color.slice(1); // Remove #
                usePound = true;
            }

            // Parse hex color string into RGB components
            let r = parseInt(color.substring(0, 2), 16);
            let g = parseInt(color.substring(2, 4), 16);
            let b = parseInt(color.substring(4, 6), 16);

            // Adjust RGB values, clamping them between 0 (black) and 255 (white)
            r = Math.min(255, Math.max(0, r + amount));
            g = Math.min(255, Math.max(0, g + amount));
            b = Math.min(255, Math.max(0, b + amount));

            // Convert the adjusted RGB components back into a hex color string
            const newColor = `#${(1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1)}`;
            return usePound ? newColor : newColor.slice(1); // Return with # if original color had it
        }
        
        // Adjust scroll height and overflow based on whether the second page content is used
        function adjustScrollHeight() {
            if (!hasSecondPageContent) { // If only one page of content
                 document.body.style.minHeight = '100vh'; // Ensure body takes full viewport height
                 document.documentElement.style.height = 'auto';
                 document.body.style.overflowY = 'auto'; // Allow scrolling if content exceeds viewport height
            } else { // If multiple pages, let content determine height
                document.body.style.minHeight = '100vh'; // Still maintain minimum height
                document.body.style.height = 'auto';
                document.body.style.overflowY = 'auto';
            }
        }
        
        // Event Listener for username input: shows action buttons when a name is entered
        userNameInput.addEventListener('input', () => {
            if (userNameInput.value.trim()) { // Check if username input is not empty
                actionButtonsContainer.classList.remove('hidden'); // Show the buttons
            } else {
                actionButtonsContainer.classList.add('hidden'); // Hide buttons if input is cleared
            }
        });
        
        // Event Listener for the translate button: toggles between Hindi and English wishes
        translateBtn.addEventListener('click', () => {
            // Only proceed if an English wish is actually available
            if (!originalEnglishWish || originalEnglishWish.trim() === '') {
                englishWishElement.textContent = ""; // Clear if empty
                translateBtn.classList.add('hidden'); // Hide the button
                return;
            }
            
            if (isTranslated) { // Currently showing English, switch back to Hindi
                hindiWishElement.classList.remove('hidden');
                englishWishElement.classList.add('hidden');
                translateBtn.textContent = 'Translate to English'; // Update button text
            } else { // Currently showing Hindi, switch to English
                hindiWishElement.classList.add('hidden');
                englishWishElement.classList.remove('hidden');
                translateBtn.textContent = 'Show in Hindi'; // Update button text
            }
            isTranslated = !isTranslated; // Toggle the translation state
        });
        
        // Event Listener for the share button: handles sharing functionality
        shareBtn.addEventListener('click', async () => {
            const name = userNameInput.value.trim() || "Someone"; // Get username or default to "Someone"
            const shareMessage = `${name} ${shareDescription}\n${FIXED_SHARE_URL}`; // Construct the share message

            try {
                if (navigator.share) { // Use Web Share API if available (primarily for mobile)
                    await navigator.share({
                        title: document.title, // Page title for sharing
                        text: shareMessage,    // The message to share
                        url: FIXED_SHARE_URL   // The URL to share
                    });
                } else if (navigator.clipboard) { // Use Clipboard API if available (desktop/modern mobile)
                    await navigator.clipboard.writeText(shareMessage); // Copy the message to the clipboard
                    alert('Share message copied to clipboard!');
                    // Optionally, attempt to open WhatsApp on mobile for direct sharing
                    if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                        window.open(`https://wa.me/?text=${encodeURIComponent(shareMessage)}`, '_blank');
                    }
                } else { // Fallback for older browsers or environments without Clipboard API
                    // Attempt to open WhatsApp on mobile
                    if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                        window.open(`https://wa.me/?text=${encodeURIComponent(shareMessage)}`, '_blank');
                    } else {
                        // For desktop, use a manual copy method if Clipboard API fails
                        fallbackCopyText(shareMessage);
                    }
                }
            } catch (err) {
                console.error('Error during sharing:', err);
                alert('Could not share the wish. Please try copying the link manually: ' + FIXED_SHARE_URL);
            }
        });
        
        // Event Listener for the copy button: copies the wish message to the clipboard
        copyBtn.addEventListener('click', () => {
            const name = userNameInput.value.trim() || "Someone";
            const shareMessage = `${name} ${shareDescription}\n${FIXED_SHARE_URL}`;
            
            if (navigator.clipboard) { // Prefer Clipboard API for copying
                navigator.clipboard.writeText(shareMessage).then(() => {
                    alert('Wish copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy text using Clipboard API:', err);
                    fallbackCopyText(shareMessage); // Use fallback if Clipboard API fails
                });
            } else {
                fallbackCopyText(shareMessage); // Use fallback if Clipboard API is not available
            }
        });
        
        // Fallback function for copying text to clipboard using execCommand (for older browsers)
        function fallbackCopyText(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            // Make the textarea invisible and off-screen to avoid visual disruption
            textArea.style.position = 'absolute';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea); // Add to DOM
            textArea.select(); // Select the text within the textarea
            
            try {
                document.execCommand('copy'); // Execute the copy command
                alert('Wish copied to clipboard!');
            } catch (err) {
                console.error('Fallback copy failed:', err);
                alert('Could not copy text. Please select and copy manually.');
            }
            
            document.body.removeChild(textArea); // Remove the temporary textarea from the DOM
        }
        
        // Initialize the application when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings(); // Load settings from Supabase
            // Add a resize event listener to re-adjust layout elements (frames, text sizes) on window resize or orientation change
            window.addEventListener('resize', () => {
                adjustFrameHeightsAndTextPadding();
                adjustScrollHeight();
            });
        });
    </script>
</body>
</html>